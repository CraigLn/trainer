<?xml version="1.0" encoding="UTF-8"?>
<% number_of_tests = @results.map {|r| r[:number_of_tests] }.reduce(:+) %>
<% number_of_failures = @results.map {|r| r[:number_of_failures] }.reduce(:+) %>

<testsuites tests="<%= number_of_tests %>" failures="<%= number_of_failures %>">
  <% @results.each do |testsuite| %>
    <% run_destination = testsuite[:run_destination] %>
    <% target_device = run_destination[:target_device] %>
    <% testsuite_name = "#{testsuite[:target_name]} - #{run_destination[:name]} (#{target_device[:operating_system_version]})" %>
    <testsuite name=<%= testsuite_name.encode(:xml => :attr) %> tests="<%= testsuite[:number_of_tests] %>" failures="<%= testsuite[:number_of_failures] %>" time="<%= testsuite[:duration] %>">
        <properties>
            <property name="RunDestination.Name" value="<%= run_destination[:name] %>"/>
            <property name="RunDestination.TargetArchitecture" value="<%= run_destination[:target_architecture] %>"/>
            <property name="RunDestination.TargetDevice.Identifier" value="<%= target_device[:identifier] %>"/>
            <property name="RunDestination.TargetDevice.Name" value="<%= target_device[:name] %>"/>
            <property name="RunDestination.TargetDevice.OperatingSystemVersion" value="<%= target_device[:operating_system_version] %>"/>
        </properties>
      <% testsuite[:tests].each do |test| %>
        <testcase classname=<%= test[:test_group].encode(:xml => :attr) %> name=<%= test[:name].encode(:xml => :attr) %> time="<%= test[:duration] %>">
          <% (test[:failures] || []).each do |failure| %>
            <failure message=<%= failure[:failure_message].encode(:xml => :attr) %>>
            </failure>
          <% end %>
        </testcase>
      <% end %>
    </testsuite>
  <% end %>
</testsuites>
